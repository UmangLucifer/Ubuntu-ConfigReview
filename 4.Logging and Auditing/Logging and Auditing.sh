# Type - Configuration Audit Script
# Author - Umang Verma
# Application Name - Ubuntu
#!/bin/bash

check_file(){
	x="$t"
	if [ ! -f $x ]; then
		echo "File $x not found"
	fi
}

echo "Audit script for Ubuntu is running. Kindly wait for the script to terminate."

exec > `hostname`_LoggingandAuditing.txt 2>errors4.txt

echo "LIN_00 - System Information"
hostname
/sbin/ifconfig -a|grep "inet addr"

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "............................................Logging and Auditing................................."
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo ".........................................Configure System Accounting.........................."
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"

echo "UBTU_16.04_4.1.1.1 Ensure audit log storage size is configured"
grep max_log_file /etc/audit/auditd.conf 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.1.1.2. Ensure system is disabled when audit logs are full"
grep space_left_action /etc/audit/auditd.conf 2>/dev/null
t=$_
check_file $t
grep action_mail_acct /etc/audit/auditd.conf
t=$_
check_file $t
grep admin_space_left_action /etc/audit/auditd.conf
t=$_
check_file $t
echo



echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.1.1.3 Ensure audit logs are not automatically deleted (Scored)"
grep max_log_file_action /etc/audit/auditd.conf 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"



echo "UBTU_16.04_4.1.2 Ensure auditd service is enabled (Scored)"
systemctl is-enabled auditd 2>/dev/null
t=$_
check_file $t
echo



echo "*********************************************************************************************************"
echo "*********************************************************************************************************"

echo "UBTU_16.04_4.1.3 Ensure auditing for processes that start prior to auditd is enabled (Scored)"
grep "^\s*linux" /boot/grub/grub.cfg 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"



echo "UBTU_16.04_4.1.4 Ensure events that modify date and time information are collected"
grep time-change /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"



echo "UBTU_16.04_4.1.5 Ensure events that modify user/group information are collected (Scored)"
grep identity /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo



echo "*********************************************************************************************************"
echo "*********************************************************************************************************"



echo "UBTU_16.04_4.1.6 Ensure events that modify the system's network environment are collected (Scored)"
grep system-locale /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.1.7 Ensure events that modify the system's Mandatory Access Controls are collected (Scored)"
grep MAC-policy /etc/audit/audit.rules 2>/dev/null
t=$_
grep MAC-policy /etc/audit/audit.rules 
t=$_
check_file $t
echo

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"




echo "UBTU_16.04_4.1.8 Ensure login and logout events are collected (Scored)"
grep logins /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.1.9 Ensure session initiation information is collected (Scored)"
grep session /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"

echo "UBTU_16.04_4.1.10 Ensure discretionary access control permission modification"
grep perm_mod /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"



echo "UBTU_16.04_4.1.11 Ensure unsuccessful unauthorized file access attempts are collected (Scored)"
grep access /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"



echo "UBTU_16.04_4.1.12 Ensure use of privileged commands is collected (Scored)"
find <partition> -xdev \( -perm -4000 -o -perm -2000 \) -type f | awk '{print \ "-a always,exit -F path=" $1 " -F perm=x -F auid>=1000 -F auid!=4294967295 \ -k privileged" }' 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"



echo "UBTU_16.04_4.1.13 Ensure successful file system mounts are collected (Scored)"
grep mounts /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo



echo "*********************************************************************************************************"
echo "*********************************************************************************************************"

echo "UBTU_16.04_4.1.14 Ensure file deletion events by users are collected (Scored)"
grep delete /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.1.15 Ensure changes to system administration scope (sudoers) is collected (Scored)"
grep scope /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"



echo "UBTU_16.04_4.1.16. Ensure system administrator actions (sudolog) are collected"
grep actions /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo



echo "*********************************************************************************************************"
echo "*********************************************************************************************************"



echo "UBTU_16.04_4.1.17. Ensure kernel module loading and unloading is collected"
grep modules /etc/audit/audit.rules 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.1.18. Ensure the audit configuration is immutable"
grep "^\s*[^#]" /etc/audit/audit.rules | tail -1 2>/dev/null
t=$_
check_file $t
echo

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"




echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "................................................Configure Logging................................"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "................................................Configure rsyslog................................"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.2.1.1. Ensure rsyslog Service is enabled"
systemctl is-enabled rsyslog 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.2.1.2. Ensure logging is configured"
ls -l /var/log/ 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.2.1.3. Ensure rsyslog default file permissions configured"
grep ^\$FileCreateMode /etc/rsyslog.conf 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"

echo "UBTU_16.04_4.2.1.4 Ensure rsyslog is configured to send logs to a remote log host"
grep "^*.*[^I][^I]*@" /etc/rsyslog.conf 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.2.1.5 Ensure remote rsyslog messages are only accepted on designated log hosts."
grep '$ModLoad imtcp.so' /etc/rsyslog.conf 2>/dev/null
t=$_
check_file $t
grep '$InputTCPServerRun' /etc/rsyslog.conf
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"




echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "...........................................Configure syslog-ng...................................."
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.2.2.1. Ensure syslog-ng service is enabled"
systemctl is-enabled syslog-ng 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.2.2.2 Ensure logging is configured"
ls -l /var/log/ 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.2.2.3. Ensure syslog-ng default file permissions configured"
grep ^options /etc/syslog-ng/syslog-ng.conf 2>/dev/null
t=$_
check_file $t
echo


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.2.2.4 Ensure syslog-ng is configured to send logs to a remote log host"
echo "manual test"
echo "Review the /etc/syslog-ng/syslog-ng.conf file and verify that logs are sent to a central host (where logfile.example.com is the name of your central log host)"


echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.2.2.5 Ensure remote syslog-ng messages are only accepted on designated log hosts"
echo "manual"
echo "Review the /etc/syslog-ng/syslog-ng.conf file and verify the following lines are configured appropriately on designated log hosts"

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"





echo "UBTU_16.04_4.2.3 Ensure rsyslog or syslog-ng is installed"
dpkg -s rsyslog 2>/dev/null
t=$_
check_file $t
dpkg -s syslog-ng
t=$_
check_file $t
echo



echo "*********************************************************************************************************"
echo "*********************************************************************************************************"

echo "UBTU_16.04_4.2.4 Ensure permissions on all logfiles are configured"
find /var/log -type f -ls 2>/dev/null
t=$_
check_file $t
echo



echo "*********************************************************************************************************"
echo "*********************************************************************************************************"


echo "UBTU_16.04_4.3 Ensure logrotate is configured"
echo "manual Test"
echo "Review /etc/logrotate.conf and /etc/logrotate.d/* and verify logs are rotated"
echo

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"

echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo ".................................................END OF OUTPUT........................................."
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"
echo "*********************************************************************************************************"